<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=390, initial-scale=1.0" />
  <title>MINT ME</title>

  <!-- Farcaster Mini App Metadata -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://arb-nft.vercel.app/image.png",
    "button":{
      "title":"MINT ME",
      "action":{
        "type":"launch_frame",
        "name":"MINT ME",
        "url":"https://arb-nft.vercel.app",
        "splashImageUrl":"https://arb-nft.vercel.app/splash.png",
        "splashBackgroundColor":"#111111"
      }
    }
  }' />

  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 16px 0;
      box-sizing: border-box;
    }
    .tradingview-widget-container {
      width: 100%;
      max-width: 390px;
      height: 200px;
      border: 1px solid #333;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .status-box {
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      width: 90%;
      max-width: 320px;
      margin-bottom: 12px;
    }
    .status-warning { background: #b45309; }
    .mint-button {
      padding: 1rem 2rem;
      font-size: 1.4rem;
      font-weight: bold;
      color: black;
      background: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .mint-button:disabled {
      background: #888;
      cursor: not-allowed;
    }
    #statusBox {
      min-height: 24px;
      width: 90%;
      max-width: 320px;
      margin-bottom: 16px;
    }
    .status-success { background: #1d4ed8; }
    #preview {
      width: 80%;
      max-width: 300px;
      border: 1px solid #444;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    #shareBtn {
      display: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      color: white;
      background: #2563eb;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 8px;
    }
    footer {
      margin-top: auto;
      display: flex;
      gap: 24px;
      padding-bottom: 12px;
    }
    footer svg {
      fill: white;
      width: 28px;
      height: 28px;
    }
  </style>
</head>
<body>

  <!-- 1. Live ARBUSD chart -->
  <div class="tradingview-widget-container">
    <div id="arb-chart"></div>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
      new TradingView.widget({
        autosize: true,
        symbol: "ARBUSD",
        interval: "60",
        theme: "dark",
        hide_top_toolbar: true,
        withdateranges: false,
        toolbar_bg: "#1f1f1f",
        locale: "en",
        enable_publishing: false,
        allow_symbol_change: false,
        container_id: "arb-chart"
      });
    </script>
  </div>

  <!-- 2. Total Minted -->
  <div id="totalSupply" class="status-box status-warning">
    Loading total mintedâ€¦
  </div>

  <!-- 3. Preview of last minted -->
  <img id="preview" src="" alt="Your NFT Preview" style="display:none" />

  <!-- 4. Mint UI -->
  <button class="mint-button">MINT ME</button>
  <div id="statusBox" class="status-box"></div>

  <!-- 5. Share button -->
  <button id="shareBtn">Share on Warpcast</button>

  <!-- Footer -->
  <footer>
    <a href="https://farcaster.xyz/pratiksharma.eth" target="_blank" aria-label="Farcaster">
      <!-- Farcaster icon SVG -->
      <svg viewBox="0 0 24 24"><path fill="white" d="M18.24 0.24H5.76â€¦"/></svg>
    </a>
    <a href="https://x.com/Pratiksharma95" target="_blank" aria-label="Twitter">
      <!-- X (Twitter) icon SVG -->
      <svg viewBox="0 0 24 24"><path fill="white" d="M1.5 0L9â€¦"/></svg>
    </a>
  </footer>

  <!-- Farcaster SDK -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    sdk.actions.ready({ disableNativeGestures: true });
  </script>

  <!-- Wagmi + Farcaster MiniApp Logic -->
  <script type="module">
    import {
      createConfig,
      connect,
      writeContract,
      readContract,
      http
    } from 'https://esm.sh/@wagmi/core';
    import { arbitrum } from 'https://esm.sh/@wagmi/core/chains';
    import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';
    import { parseEther } from 'https://esm.sh/viem';

    const statusBox = document.getElementById('statusBox');
    const supplyBox  = document.getElementById('totalSupply');
    const preview    = document.getElementById('preview');
    const shareBtn   = document.getElementById('shareBtn');

    function setStatus(msg, type = 'info') {
      statusBox.className = `status-box status-${type}`;
      statusBox.innerHTML = msg;
    }

    const config = createConfig({
      chains: [arbitrum],
      transports: { [arbitrum.id]: http() }
    });

    let lastTokenId = null;

    // 1) Connect + fetch totalSupply
    (async () => {
      try {
        await connect(config, { connector: farcasterMiniApp() });
        const { address, abi } = await fetch('/contract.json').then(r=>r.json());
        const total = await readContract(config, {
          address, abi, functionName: 'totalSupply'
        });
        supplyBox.textContent = `Total Minted: ${total}`;
      } catch (e) {
        console.warn('Init error:', e);
        supplyBox.textContent = 'Total Minted: N/A';
      }
    })();

    // 2) Mint handler
    document.querySelector('.mint-button').addEventListener('click', async () => {
      const btn = document.querySelector('.mint-button');
      btn.disabled = true;
      btn.innerText = 'Mintingâ€¦';
      preview.style.display = 'none';
      shareBtn.style.display = 'none';
      try {
        const { address, abi } = await fetch('/contract.json').then(r=>r.json());
        // mint
        const hash = await writeContract(config, {
          address, abi,
          functionName: 'mint',
          args: [], value: parseEther('0')
        });
        setStatus(
          `âœ… Mint Successful <a href="https://arbiscan.io/tx/${hash}" target="_blank" style="color:#fff;text-decoration:underline">View Tx</a>`,
          'success'
        );
        // fetch new total
        const total = await readContract(config, {
          address, abi, functionName: 'totalSupply'
        });
        supplyBox.textContent = `Total Minted: ${total}`;
        // assume tokenId = total-1
        lastTokenId = BigInt(total) - 1n;
        // fetch tokenURI
        const uri = await readContract(config, {
          address, abi, functionName: 'tokenURI', args: [lastTokenId]
        });
        // load preview image
        preview.src = uri;
        preview.style.display = 'block';
        // show share button
        shareBtn.style.display = 'inline-block';
      } catch (e) {
        console.warn('Mint failed:', e);
      } finally {
        btn.disabled = false;
        btn.innerText = 'MINT ME';
      }
    });

    // 3) Share handler
    shareBtn.addEventListener('click', () => {
      const text = encodeURIComponent(
        `Minted NFT #${lastTokenId} on Farcaster by @pratiksharma.eth ðŸŽ‰\nhttps://arb-nft.vercel.app/`
      );
      // external compose
      sdk.actions.openUrl(`https://warpcast.com/compose?text=${text}`);
    });
  </script>
</body>
</html>