<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=390, initial-scale=1.0" />
  <title>MINT ME</title>

  <!-- Farcaster Mini App Metadata -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://arb-nft.vercel.app/image.png",
    "button":{
      "title":"MINT ME",
      "action":{
        "type":"launch_frame",
        "name":"MINT ME",
        "url":"https://arb-nft.vercel.app",
        "splashImageUrl":"https://arb-nft.vercel.app/splash.png",
        "splashBackgroundColor":"#111111"
      }
    }
  }' />

  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 16px 0;
      box-sizing: border-box;
    }
    .status-box {
      margin: 12px 0;
      padding: 8px 16px;
      border-radius: 8px;
      text-align: center;
      width: 90%;
      max-width: 320px;
      background: #b45309;
    }
    .status-success { background: #1d4ed8; }
    button {
      font-size: 1.2rem;
      padding: 0.8rem 1.6rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .mint-button {
      background: #fff;
      color: #000;
      margin-bottom: 12px;
    }
    .mint-button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #shareBtn {
      background: #2563eb;
      color: #fff;
      margin-bottom: 16px;
    }
    footer {
      margin-top: auto;
      padding-bottom: 12px;
      display: flex;
      gap: 16px;
    }
    footer svg {
      fill: #fff;
      width: 28px;
      height: 28px;
    }
  </style>
</head>
<body>

  <!-- 1. Total minted -->
  <div id="totalSupply" class="status-box">Loading total mintedâ€¦</div>

  <!-- 2. Mint -->
  <button class="mint-button">MINT ME</button>
  <div id="statusBox" class="status-box" style="display:none;"></div>

  <!-- 3. Share -->
  <button id="shareBtn">Share on Farcaster</button>

  <!-- 4. Footer -->
  <footer>
    <a href="https://farcaster.xyz/pratiksharma.eth" target="_blank" aria-label="Farcaster">
      <svg viewBox="0 0 24 24"><path d="M18.24 0.24H5.76C2.5789 ..."/></svg>
    </a>
    <a href="https://x.com/Pratiksharma95" target="_blank" aria-label="X">
      <svg viewBox="0 0 24 24"><path d="M1.5 0L9 10.125 ..."/></svg>
    </a>
  </footer>

  <!-- Farcaster SDK -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    sdk.actions.ready({ disableNativeGestures: true });
  </script>

  <!-- Wagmi Integration -->
  <script type="module">
    import { createConfig, connect, writeContract, readContract } from 'https://esm.sh/@wagmi/core';
    import { http } from 'https://esm.sh/@wagmi/core/transports';
    import { arbitrum } from 'https://esm.sh/@wagmi/core/chains';
    import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';
    import { parseEther } from 'https://esm.sh/viem';

    const totalSupplyEl = document.getElementById('totalSupply');
    const statusBox     = document.getElementById('statusBox');
    const mintBtn       = document.querySelector('.mint-button');
    const shareBtn      = document.getElementById('shareBtn');
    let lastTokenId     = null;

    // Initialize Wagmi & Farcaster Wallet
    const config = createConfig({
      chains: [arbitrum],
      transports: { [arbitrum.id]: http() }
    });

    (async () => {
      await connect(config, { connector: farcasterMiniApp() });
      const { address, abi } = await fetch('/contract.json').then(r => r.json());
      try {
        const total = await readContract({ address, abi, functionName: 'totalSupply' });
        totalSupplyEl.textContent = `Total Minted: ${total}`;
      } catch {
        totalSupplyEl.textContent = 'Total Minted: N/A';
      }
    })();

    // Mint handler
    mintBtn.addEventListener('click', async () => {
      mintBtn.disabled = true;
      mintBtn.textContent = 'Mintingâ€¦';
      const { address, abi } = await fetch('/contract.json').then(r => r.json());
      try {
        const hash = await writeContract({
          address,
          abi,
          functionName: 'mint',
          args: [],
          value: parseEther('0')
        });
        statusBox.style.display = 'block';
        statusBox.className = 'status-box status-success';
        statusBox.innerHTML = `âœ… Mint Successful <a href="https://arbiscan.io/tx/${hash}" target="_blank" style="color:#fff;text-decoration:underline">View Tx</a>`;
        // update supply & lastTokenId
        const total = await readContract({ address, abi, functionName: 'totalSupply' });
        totalSupplyEl.textContent = `Total Minted: ${total}`;
        lastTokenId = BigInt(total) - 1n;
      } catch (e) {
        console.error(e);
      } finally {
        mintBtn.disabled = false;
        mintBtn.textContent = 'MINT ME';
      }
    });

    // Share handler
    shareBtn.addEventListener('click', () => {
      const msg = lastTokenId !== null
        ? `Minted NFT #${lastTokenId} by @pratiksharma.eth ðŸŽ‰\nMint yours: https://arb-nft.vercel.app/`
        : `Free Arbitrum NFT on Farcaster: https://arb-nft.vercel.app/`;
      const text = encodeURIComponent(msg);
      sdk.actions.openWindow({ url: `https://farcaster.xyz/compose?text=${text}` });
    });
  </script>
</body>
</html>