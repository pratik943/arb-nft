<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=390, initial-scale=1.0" />
  <title>Arbitrum Free Mint</title>

  <!-- Farcaster Mini App Metadata -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://arb-nft.vercel.app/image.png",
    "button":{
      "title":"Free Mint",
      "action":{
        "type":"launch_frame",
        "name":" Arbitrum Szn",
        "url":"https://arb-nft.vercel.app",
        "splashImageUrl":"https://arb-nft.vercel.app/splash.png",
        "splashBackgroundColor":"#111111"
      }
    }
  }' />

  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 16px 0;
      box-sizing: border-box;
    }
    .tradingview-widget-container {
      width: 100%;
      max-width: 390px;
      height: 200px;
      border: 1px solid #333;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .status-box {
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      width: 90%;
      max-width: 320px;
      margin-bottom: 12px;
    }
    .status-warning { background: #b45309; }
    .mint-button {
      padding: 1rem 2rem;
      font-size: 1.4rem;
      font-weight: bold;
      color: black;
      background: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }
    .mint-button:disabled {
      background: #888;
      cursor: not-allowed;
    }
    #statusBox {
      min-height: 24px;
      width: 90%;
      max-width: 320px;
      margin-bottom: 16px;
    }
    .status-success { background: #1d4ed8; }
    .opensea-embed {
      width: 100%;
      max-width: 390px;
      height: 300px;
      border: none;
      border-radius: 12px;
      margin-top: 16px;
    }
    footer {
      margin-top: auto;
      display: flex;
      gap: 24px;
      padding-bottom: 12px;
    }
    footer svg {
      fill: white;
      width: 28px;
      height: 28px;
    }
  </style>
</head>
<body>

  <!-- 1. Live ARBUSD chart -->
  <div class="tradingview-widget-container">
    <div id="arb-chart"></div>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
      new TradingView.widget({
        autosize: true,
        symbol: "ARBUSD",
        interval: "60",
        theme: "dark",
        hide_top_toolbar: true,
        withdateranges: false,
        toolbar_bg: "#1f1f1f",
        locale: "en",
        enable_publishing: false,
        allow_symbol_change: false,
        container_id: "arb-chart"
      });
    </script>
  </div>

  <!-- 2. Total Minted -->
  <div id="totalSupply" class="status-box status-warning">
    Loading total minted…
  </div>

  <!-- 3. Mint UI -->
  <button class="mint-button">MINT ME</button>
  <div id="statusBox" class="status-box"></div>

  <!-- 4. OpenSea FarArb gallery -->
  <iframe
    src="https://opensea.io/collection/fararb?embed=true"
    class="opensea-embed"
    allowfullscreen
  ></iframe>

  <!-- Footer -->
  <footer>
    <a href="https://farcaster.xyz/pratiksharma.eth" target="_blank" aria-label="Farcaster">
      <!-- Farcaster icon SVG -->
      <svg viewBox="0 0 24 24"><path fill="white" d="M18.24 0.24H5.76C2.5789 0.24 0 2.8188 0 6v12c0 3.1811 2.5789 5.76 5.76 5.76h12.48c3.1812 0 5.76 -2.5789 5.76 -5.76V6C24 2.8188 21.4212 0.24 18.24 0.24m0.8155 17.1662v0.504c0.2868 -0.0256 0.5458 0.1905 0.5439 0.479v0.5688h-5.1437v-0.5688c-0.0019 -0.2885 0.2576 -0.5047 0.5443 -0.479v-0.504c0 -0.22 0.1525 -0.402 0.358 -0.458l-0.0095 -4.3645c-0.1589 -1.7366 -1.6402 -3.0979 -3.4435 -3.0979 -1.8038 0 -3.2846 1.3613 -3.4435 3.0979l-0.0096 4.3578c0.2276 0.0424 0.5318 0.2083 0.5395 0.4648v0.504c0.2863 -0.0256 0.5457 0.1905 0.5438 0.479v0.5688H4.3915v-0.5688c-0.0019 -0.2885 0.2575 -0.5047 0.5438 -0.479v-0.504c0 -0.2529 0.2011 -0.4548 0.4536 -0.4724v-7.895h-0.4905L4.2898 7.008l2.6405 -0.0005V5.0419h9.9495v1.9656h2.8219l-0.6091 2.0314h-0.4901v7.8949c0.2519 0.0177 0.453 0.2195 0.453 0.4724"/></svg>
    </a>
    <a href="https://x.com/Pratiksharma95" target="_blank" aria-label="Twitter">
      <!-- X (Twitter) icon SVG -->
      <svg viewBox="0 0 24 24"><path fill="white" d="M1.5 0L9 10.125 1.575 24H6.15L12 14.4l5.85 9.6h4.575L15 10.05 22.425 0h-4.575L12 9.6 6.15 0H1.5Z"/></svg>
    </a>
  </footer>

  <!-- Farcaster SDK -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    sdk.actions.ready({ disableNativeGestures: true });
  </script>

  <!-- Wagmi + Farcaster MiniApp Logic -->
  <script type="module">
    import {
      createConfig,
      connect,
      writeContract,
      readContract,
      http
    } from 'https://esm.sh/@wagmi/core';
    import { arbitrum } from 'https://esm.sh/@wagmi/core/chains';
    import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';
    import { parseEther } from 'https://esm.sh/viem';

    const statusBox = document.getElementById('statusBox');
    const supplyBox  = document.getElementById('totalSupply');

    function setStatus(message, type = 'info') {
      statusBox.className = `status-box status-${type}`;
      statusBox.innerHTML = message;
    }

    const config = createConfig({
      chains: [arbitrum],
      transports: { [arbitrum.id]: http() }
    });

    // 1) Connect Farcaster wallet & fetch totalSupply
    (async () => {
      try {
        await connect(config, { connector: farcasterMiniApp() });
      } catch (e) {
        console.error('Farcaster connect failed', e);
      }
      try {
        const { address, abi } = await fetch('/contract.json').then(r => r.json());
        const total = await readContract(config, {
          address,
          abi,
          functionName: 'totalSupply'
        });
        supplyBox.textContent = `Total Minted: ${total}`;
      } catch (e) {
        console.warn('Failed fetching totalSupply:', e);
        supplyBox.textContent = 'Total Minted: N/A';
      }
    })();

    // 2) Mint handler + share cast
    document.querySelector('.mint-button').addEventListener('click', async () => {
      const btn = document.querySelector('.mint-button');
      btn.disabled = true;
      btn.innerText = 'Minting…';
      try {
        const { address, abi } = await fetch('/contract.json').then(r => r.json());
        const hash = await writeContract(config, {
          address,
          abi,
          functionName: 'mint',
          args: [],
          value: parseEther('0')
        });
        setStatus(
          `✅ Mint Successful <a href="https://arbiscan.io/tx/${hash}" target="_blank" style="color:#fff;text-decoration:underline">View Tx</a>`,
          'success'
        );
        // share as cast in browser (outside miniapp)
        const text = encodeURIComponent(
          'Minted Successfully Free Nft By @pratiksharma.eth\nMint Yours https://arb-nft.vercel.app/'
        );
        window.open(`https://farcaster.xyz/compose?text=${text}`, '_blank');
      } catch (e) {
        console.warn('Mint rejected or failed', e);
      } finally {
        btn.disabled = false;
        btn.innerText = 'Mint';
      }
    });
  </script>
</body>
</html>